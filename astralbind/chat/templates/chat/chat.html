{% load static %}

<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Чат: {{ room_name }}</title>
        <link rel="stylesheet" href="{% static 'chat.css' %}" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    </head>
    <body>
        <div class="page-container">
            <div class="nav-buttons">
                <div>
                    <a href="{% url 'main_page' %}" class="back-main">Главная страница</a>
                    <a href="{% url 'chats_list' %}" class="back-list">Чаты</a>
                </div>
                <a href="{% url 'profile' %}" class="back-profile">Профиль</a>
            </div>

            <div class="content">
                <div class="chats-container" id="chats-container">
                    {% for message in messages %}
                        <div class="single-message {% if message.sender.user.username == user %}sent{% endif %}">
                            <div class="msg-body">{{ message.message }}</div>
                            <p class="sender">
                                {% if message.sender.user.username == user %}
                                    Вы
                                {% else %}
                                    {{ message.sender.user.username }}
                                {% endif %}
                            </p>
                        </div>
                    {% empty %}
                        <div class="no-messages">Сообщений пока нет.</div>
                    {% endfor %}
                </div>
                <form action="" id="msg-form" method="post">
                    <textarea
                        name="message"
                        id="message"
                        cols="30"
                        rows="2"
                        placeholder="Введите сообщение..."
                    ></textarea>
                    <button type="submit">&#10003;</button>
                </form>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const socketURL = `ws://${window.location.host}/ws/chats/{{ room_name }}/`;
                const socket = new WebSocket(socketURL);
                const messageForm = document.getElementById("msg-form");
                const messageInput = document.getElementById("message");
                const chatsDiv = document.getElementById("chats-container");

                scrollToBottom();

                messageForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    sendMessage();
                });

                messageInput.addEventListener("keydown", (event) => {
                    if (event.key === "Enter" && !event.shiftKey) {
                        event.preventDefault();
                        sendMessage();
                    }
                });

                messageInput.addEventListener("input", () => {
                    messageInput.style.height = "auto";
                    messageInput.style.height = `${messageInput.scrollHeight}px`;
                });

                socket.addEventListener("message", (e) => {
                    const data = JSON.parse(e.data);

                    if (!data.saved) {
                        appendMessage(data.sender, data.message);
                    }
                    else {
                        const lastMessage = chatsDiv.lastElementChild;
                        if (lastMessage && !lastMessage.querySelector('.msg-body').textContent.includes(data.message)) {
                            appendMessage(data.sender, data.message);
                        }
                    }
                });

                function sendMessage() {
                    const message = messageInput.value.trim();
                    if (message) {
                        socket.send(JSON.stringify({
                            message: message,
                            sender: "{{ user }}"
                        }));
                        messageInput.value = "";
                        messageInput.style.height = "auto";
                    }
                }

                function appendMessage(sender, content) {
                    const messageDiv = document.createElement("div");
                    messageDiv.className = `single-message ${sender === "{{ user }}" ? "sent" : ""}`;

                    const bodyDiv = document.createElement("div");
                    bodyDiv.className = "msg-body";
                    bodyDiv.textContent = content;

                    const senderP = document.createElement("p");
                    senderP.className = "sender";
                    senderP.textContent = sender === "{{ user }}" ? "Вы" : sender;

                    messageDiv.appendChild(bodyDiv);
                    messageDiv.appendChild(senderP);
                    chatsDiv.appendChild(messageDiv);

                    scrollToBottom();
                }

                function scrollToBottom() {
                    chatsDiv.scrollTop = chatsDiv.scrollHeight;
                }
            });
        </script>
    </body>
</html>
